<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"    content="width=device-width">
  <meta name="author"      content="M A Eyler, Istanbul, 2020" />
  <link rel="icon" href="image/icon.png">
  <title>Yer işaretleri</title>

  <style>
    body {max-width: 540px;}
    p { font: 11pt/1.3 sans-serif; }
    img {
        position: fixed;
        top:8px; right:8px;
        width: 50px;
    }
    pre {
        overflow-x: auto;
        line-height: 1.3;
    }
    #input { width: 90%; }
  </style>

</head>

<body>

<h2 id=title></h2>
<img id=image>
<p>
    Kullandığınız cihazlar arasında yer işaretlerini eşitlemek 
    için Google Drive hesabınızdan yetki vermelisiniz.
    Giriş düğmesi ile hesaba girmek yeterli.
    İstenen yetki, sadece bu yazılıma ait olan "iqra bookmarks"
    klasörüne erişim izninden ibarettir. Drive içindeki diğer 
    dosyalara erişim hakkı <b>yok</b>. </p><p>
    Bu cihazda saklanan yerel işaretler ile Google Drive içindeki
    işaretler birleştirilir ve onayınıza sunulur. 
    Yer işaretleri, yıldızlı sayfaların numarasıdır.
    İki kümeden sadece birini ilgili düğme ile seçebilirsiniz.
    En çok 12 işaret (sayfa numarası) saklanabilir.
    Onay düğmesi ile iki veri kümesi eşitlenir.
</p><p>
<button id=auth onclick="doSignIn()">Giriş</button>
&nbsp; <span id=user></span>
&emsp; <input type=checkbox id=auto onchange="autoSync()">
<label for=auto>Otomatik eşitle</label> </p><p>
<button id=localB disabled onclick="useMarks(localT)">Yerel işaretler
</button> <br><span id=localT></span> </p><p>
<button id=driveB disabled onclick="useMarks(driveT)">Google Drive
</button> <br><span id=driveT></span> </p><p>
Seçilen işaretler: &emsp; 
<button id=sync disabled onclick="synchronize()">Onay</button><br>
<input type=text id=input>
<pre id=out></pre>

<script src="code/common.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
/**
 * https://developers.google.com/explorer-help/guides/code_samples
 */
function stringify(m) {
    if (typeof m === "string") return m
    return JSON.stringify(m,'',2)
}
function log(m) {
    let r = m.result? m.result : m
    console.log(m); out.style.color = ''
    out.innerText = stringify(r)
}
function error(e) {
    let r = e.error? e.error : e
    console.error(e); out.style.color = 'red'
    out.innerText = stringify(r)
}
async function doSignIn() {
  log("Authorization begins");
  try {
    await gapi.auth2.getAuthInstance().signIn()
    showFiles()
  } catch (e) { error(e) }
}
async function doLoadClient() {
  const DRIVE = 
    "https://content.googleapis.com/discovery/v1/apis/drive/v3/rest"
  if (!gapi.client.drive) try {
      log("Load drive client");
      await gapi.client.load(DRIVE)
      log("GAPI client loaded")
  } catch (e) { error(e) }
}
const FOLDER = 'application/vnd.google-apps.folder'
const FIELDS = 'files(id,name,mimeType,parents)'
async function doCreate(name, mimeType, parentId) {
  log("create "+name);
  try {
    let resource = {name, mimeType}
    if (parentId) resource.parents = [parentId]
    return gapi.client.drive.files.create(resource)
  } catch (e) { error(e) }
}
async function getFileData(fileId, fields) {
  log("getFileData "+fileId);
  try {
    return gapi.client.drive.files.get({fileId, fields})
  } catch (e) { error(e) }
}
async function doSearch(q, fields) {
  log("search "+q);
  try {
    return gapi.client.drive.files.list({q, fields})
  } catch (e) { error(e) }
}
async function doRename(fileId, name) {
  log("rename "+name)
  try {
    resource = { name }
    return gapi.client.drive.files.update({fileId, resource})
 } catch (e) { error(e) }
}
async function synchronize() {
    log("synchronize");
    if (!marksId) await getMarksId()
    let s = input.value.trim()
    if (!s) { error('need at least one bookmark'); return }
    await doRename(marksId, s)
    localT.innerText = s
    driveT.innerText = s
}
function useMarks(elt) {
    input.value = elt.innerText
}
function autoSync() {
    if (auto.checked) {
      setStorage('marksId', marksId)
    } else {
      setStorage('marksId', undefined)
    }
}
function currentUser() {
    return gapi.auth2.getAuthInstance().currentUser.get()
}
function showProfile() {
    let p = currentUser().getBasicProfile()
    image.src = p.getImageUrl()
    user.innerText = p.getEmail()
}
var folderId, marksId
const M_FOLDER = 'iqra bookmarks', M_MIME = 'text/iqra'
  apiKey = 'AIzaSyCH22pYgwYoWme6CFPiU3i_JLD-SgATteU',
  clientId = "864962883135-ut9cl3g1jlqv1frlp2p6cq9r3jsfflkv.apps.googleusercontent.com",
  scope = 'https://www.googleapis.com/auth/drive.file';
async function init() {
    await gapi.auth2.init({ apiKey, clientId, scope })
    if (!currentUser().getId()) return
    marksId = getStorage('marksId'); showFiles()
}
async function getMarksId() {
  log('getMarksId')
  let fields = FIELDS
  {
    let q = 'mimeType = "'+FOLDER+'" and name = "'+M_FOLDER+'"'
    let {result} = await doSearch(q, fields)
    let files = result.files
    if (files.length) folderId = files[0].id
    else {
      let f = await doCreate(M_FOLDER, FOLDER)
      log(f); folderId = f.id
    }
  }
    let q = 'trashed = false and mimeType contains "iqra"'
    let {result} = await doSearch(q, fields)
    let files = result.files
    if (files.length) marksId = files[0].id
    else {
      let f = await doCreate('no_name', M_MIME, folderId)
      log(f); marksId = f.id
    }
    return new Promise((resolve, reject) => resolve())
}
async function showFiles() {
    await doLoadClient(); 
    showProfile(); sync.disabled = false
    localB.disabled = false; driveB.disabled = false
    //local marks a
    let a = getStorage('marks')
    localT.innerText = a.join(' ') || '(yok)'
    //drive data b
    if (!marksId) await getMarksId()
    let str, b;
    if (marksId) {
      let f = await getFileData(marksId)
      str = f.name; b = str.split(' ')
    } else {
      str = '(yok)'; b = []
    }
    driveT.innerText = str
    //merge a & b
    const MAX = 6 //items from each list
    let n = 0 //items from b
    for (let x of b) 
      if (!a.includes(x) && (a.length<2*MAX || n<MAX)) {
        a.push(x); n++
      }
    let d = a.length - 2*MAX
    if (d > 0) a.splice(0, d)
    input.value = a.join(' ')
    setStorage('marks', a)
}
title.innerText = document.title
gapi.load("client:auth2", init);
</script>
</body>
</html>
