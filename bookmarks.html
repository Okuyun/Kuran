<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"    content="width=device-width">
  <meta name="author"      content="M A Eyler, Istanbul, 2020" />
  <link rel="icon" href="image/icon.png">
  <title>Yer işaretlerini eşitle</title>

  <style>
    body {
      max-width: 540px;
      background: #fff8d0;
    }
    p { font: 11pt/1.3 sans-serif; }
    button { cursor: pointer; }
    img {
        position: fixed;
        top:8px; right:22px;
        width: 50px;
    }
    pre {
        overflow-x: auto;
        line-height: 1.3;
    }
    #input { width: 97%; }
    #sync, #localB, #driveB { 
      background: #bcf;
      margin-bottom: 5px;
      font-size: 16px; 
    }
    .mavi { color: blue; }
    .large { font-size: 24px; }
  </style>

</head>

<body>

<h3 id=title></h3>
<img id=image>
<p>
  Bu cihazda yıldızla işaretlediğiniz sayfaları, 
  kullandığınız diğer cihazlarda da yıldızlı görmek istiyorsanız, 
  Google Drive hesabınızdan erişim izni vermeniz gerekiyor. 
  İstenen yetki, bu yazılıma ait olan "iqra bookmarks" klasörüne 
  erişmekten ibarettir, başka Drive dosyalarına erişim izni istenmiyor.
</p><p>
  İşaretleri eşitlemek için üç farklı yöntem var: <br>
  * Cihazdaki yer işaretleri buluta aktarılır. <br>
  * Buluttaki yer işaretleri cihaza aktarılır. <br>
  * Cihazdaki işaretler ile buluttaki işaretler
  birleştirilir ve tek liste olarak gösterilir.
  Kullanıcı listeyi dilediği gibi düzenler ve 
  "Eşitle" düğmesiyle iki listeyi eşitler. <br>
  Her üç durumda, yerel ve bulut işaretleri eşitlenecektir.
  Yazılım en çok 12 adet yer işareti kaydedebilir. 
</p><p>
<button id=auth onclick="doSignIn()"
title="Bulut erişimi için yetkilendirme">Giriş</button>&nbsp; 
<span id=user title="Yetki veren kullanıcı"></span>&emsp; 
<!-- <input type=checkbox id=auto onchange="autoSync()"
title="Seçili ise, yer işaretleri otomatik eşitlenir">
<label for=auto>Otomatik eşitle</label> -->
</p><p>
Buluttaki yer işaretleri (Google Drive)<br>
<span id=driveT class=mavi
title="Bulutta saklanan yer işaretleri"></span> 
</p><p>
<button id=localB disabled onclick="useMarks(localT)"
title="Buluta kaydederken oradaki eski işaretleri sil">
Buluta aktar</button>
<span class=large>⇑ &emsp; ⇓</span>
<button id=driveB disabled onclick="useMarks(driveT)"
title="Buluttan indirirken cihazdaki eski işaretleri sil">
Cihaza aktar</button>
</p><p>
Cihazdaki yer işaretleri (Yerel kayıt)<br>
<span id=localT class=mavi
title="Cihazda saklanan yer işaretleri"></span> 
</p><p>
Seçilen işaretler: &emsp; 
<button id=sync disabled onclick="useInput()"
title="Seçilen işaretleri buluta ve cihaza kaydet">Eşitle</button>
<span class=large>⇑⇑</span><br>
<input type=text id=input inputmode=numeric
title="Seçilen işaretleri dilediğniz gibi düzenleyebilirsiniz">
</p><pre id=out></pre>

<script src="code/common.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
"use strict";
/**
 * https://developers.google.com/explorer-help/guides/code_samples
 */
function stringify(m) {
    if (typeof m === "string") return m
    return JSON.stringify(m,'',2)
}
function log(m) {
    let r = m.result || m
    console.log(m); out.style.color = ''
    out.innerText = stringify(r)
}
function error(e) {
    let r = e.error || e.result ||  e
    console.error(e); out.style.color = 'red'
    out.innerText = stringify(r)
}
async function doSignIn() {
  log("Authorization");
  try {
    await gapi.auth2.getAuthInstance().signIn()
    displayMarks()
  } catch (e) { error(e) }
}
async function loadClient() {
  const DRIVE = 
    "https://content.googleapis.com/discovery/v1/apis/drive/v3/rest"
  if (!gapi.client.drive) try {
      log("Load drive client");
      await gapi.client.load(DRIVE)
      log("GAPI client loaded")
  } catch (e) { error(e) }
}
async function doCreate(name, mimeType, parentId) {
  log("create "+name);
  try {
    let resource = {name, mimeType}
    if (parentId) resource.parents = [parentId]
    return gapi.client.drive.files.create(resource)
  } catch (e) { error(e) }
}
async function getFileData(fileId, fields) {
  log("getFileData "+fileId);
  try {
    return gapi.client.drive.files.get({fileId, fields})
  } catch (e) { error(e) }
}
async function doSearch(q, fields) {
  log("search ["+q+"]");
  try {
    return gapi.client.drive.files.list({q, fields})
  } catch (e) { error(e) }
}
async function doRename(fileId, name) {
  log("rename "+name)
  try {
    let resource = { name }
    return gapi.client.drive.files.update({fileId, resource})
 } catch (e) { error(e) }
}
async function synchronize(a) {
    ensureMaxSize(a); let s = a.join(' ')
    localT.innerText = driveT.innerText = input.value = s
  //if opened by Iqra, opener.name == 'iqra' -- use a
    if (opener && opener.arrayToSet) opener.arrayToSet(a)
    setStorage('marks', a) //save a to localStorage
    if (!marksId) await getMarksId()
    await doRename(marksId, s) //save s to Drive
    log("eşitlendi");
}
function useMarks(elt) {
    synchronize(elt.innerText.split(' '))
}
function useInput() {
    let s = input.value.trim()
    if (s) synchronize(s.split(/\D+/))
    else error('at least one bookmark is needed');
}
function autoSync() {
    if (auto.checked) {
      setStorage('marksId', marksId)
    } else {
      setStorage('marksId', undefined)
    }
}
function currentUser() {
    return gapi.auth2.getAuthInstance().currentUser.get()
}
function showProfile() {
    let p = currentUser().getBasicProfile()
    image.src = p.getImageUrl()
    image.title = p.getName()+'\n'+p.getEmail()
    user.innerText = p.getEmail()
}
var folderId, marksId
const FOLDER = 'application/vnd.google-apps.folder',
  M_FOLDER = 'iqra bookmarks', M_MIME = 'text/iqra',
  apiKey = 'AIzaSyCH22pYgwYoWme6CFPiU3i_JLD-SgATteU',
  clientId = "864962883135-ut9cl3g1jlqv1frlp2p6cq9r3jsfflkv.apps.googleusercontent.com",
  scope = 'https://www.googleapis.com/auth/drive.file';
async function init() {
  try {
    await gapi.auth2.init({ apiKey, clientId, scope })
    if (!currentUser().getId()) return
    marksId = getStorage('marksId'); displayMarks()
    // auto.checked = marksId? true : false
  } catch (e) { error(e) }
}
async function getMarksId() {
  log('getMarksId')
  let fields = 'files(id,name,mimeType,parents)'
  {
    let q = 'mimeType = "'+FOLDER+'" and name = "'+M_FOLDER+'"'
    let {result} = await doSearch(q, fields)
    let files = result.files
    if (files.length) folderId = files[0].id
    else {
      let {result} = await doCreate(M_FOLDER, FOLDER)
      log(result.id); folderId = result.id
    }
  }
    let q = 'trashed = false and mimeType contains "iqra"'
    let {result} = await doSearch(q, fields)
    let files = result.files
    if (files.length) marksId = files[0].id
    else {
      let {result} = await doCreate('no_name', M_MIME, folderId)
      log(result.id); marksId = result.id
    }
    return new Promise((resolve, reject) => resolve())
}
const MAX_ITEMS = 6 //items from each list
function ensureMaxSize(a) {
    let d = a.length - 2*MAX_ITEMS
    if (d > 0) a.splice(0, d)
}
async function displayMarks() {
    await loadClient(); 
    showProfile(); sync.disabled = false
    localB.disabled = false; driveB.disabled = false
    let x = getStorage()
    //local marks a
    let a = x.marks
    localT.innerText = (a && a.join(' ')) || '(yok)'
    //drive data b
    marksId = x.marksId
    if (!marksId) await getMarksId()
    let str, b;
    if (marksId) {
      let {result} = await getFileData(marksId)
      console.log(result); str = result.name; b = str.split(' ')
    } else {
      str = '(yok)'; b = []
    }
    driveT.innerText = str
    //merge a & b
    let n = 0 //items from b
    for (let x of b) 
      if (!a.includes(x) && (a.length<2*MAX_ITEMS || n<MAX_ITEMS)) {
        a.push(x); n++
      }
    ensureMaxSize(a); input.value = a.join(' ')
}
title.innerText = document.title
gapi.load("client:auth2", init);
</script>
</body>
</html>
